<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç§åœ°å§ï¼šåä¸ªå‹¤å¤©ä¸Šå¸‚ä¹‹è·¯ (å…¸è—ç‰ˆ)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Markdown è§£æåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- å­—ä½“ -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&family=Noto+Serif+SC:wght@700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
            height: 100dvh; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .dashboard-card {
            background-color: #ffffff;
            border-radius: 0.75rem; 
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .progress-bar-fill { transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }

        /* é€‰é¡¹æŒ‰é’®æ ·å¼ */
        .choice-btn {
            border: 1px solid #e5e7eb;
            opacity: 0; 
            transform: translateY(10px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out, background-color 0.2s;
        }
        .choice-btn.visible {
            opacity: 1 !important;
            transform: translateY(0) !important;
        }
        .choice-btn:active {
            background-color: #f0fdf4;
            border-color: #10b981;
            transform: scale(0.98);
        }
        
        .sticky-stats {
            position: sticky;
            top: 0;
            z-index: 30;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid #e5e7eb;
        }

        .prose p {
            margin-bottom: 1.2em;
            line-height: 1.8;
            text-align: justify;
        }

        /* æµå¼å…‰æ ‡ */
        .streaming-cursor::after {
            content: '';
            display: inline-block;
            width: 3px;
            height: 14px;
            background-color: #10b981;
            margin-left: 2px;
            animation: blink 1s infinite;
            vertical-align: middle;
        }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

        /* ä¿¡çº¸åŠ¨ç”» */
        @keyframes paper-in {
            0% { transform: translateY(20px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        .paper-anim { animation: paper-in 0.6s ease-out forwards; }

        /* å¼¹å¹•æ‚¬æµ®å±‚ */
        .danmu-overlay {
            position: absolute;
            top: 70px;
            right: 12px;
            width: 220px;
            pointer-events: none;
            z-index: 25;
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: flex-end;
        }
        .danmu-item {
            background: rgba(255, 255, 255, 0.95);
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            animation: slide-in 0.4s ease-out;
            border: 1px solid #e5e7eb;
            max-width: 100%;
            backdrop-filter: blur(4px);
        }
        @keyframes slide-in { from { transform: translateX(20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-white border-b border-gray-200 px-4 py-3 flex justify-between items-center flex-none z-40 shadow-sm h-14">
        <div class="flex items-center gap-2" onclick="location.reload()">
            <span class="text-2xl">ğŸŒ¾</span>
            <h1 class="font-bold text-base md:text-lg text-gray-800 truncate">ç§åœ°å§ Â· AIä¸Šå¸‚è·¯</h1>
        </div>
        <div class="flex items-center gap-2">
            <span id="game-date" class="text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded whitespace-nowrap">S1 Â· Day 1</span>
            
            <div class="flex gap-1">
                <button onclick="App.saveGame()" class="p-2 text-emerald-600 bg-emerald-50 rounded-lg active:bg-emerald-100 border border-emerald-100" title="å­˜æ¡£">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" /></svg>
                </button>
                <button onclick="App.loadGame()" class="p-2 text-blue-600 bg-blue-50 rounded-lg active:bg-blue-100 border border-blue-100" title="è¯»æ¡£">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                </button>
                <button onclick="App.showSettings()" class="p-2 text-gray-500 bg-gray-50 rounded-lg active:bg-gray-100 border border-gray-100" title="è®¾ç½®">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                </button>
            </div>
        </div>
    </header>

    <!-- é¦–é¡µ -->
    <div id="screen-home" class="fixed inset-0 z-50 bg-[#f3f4f6] flex flex-col items-center justify-center p-6 transition-transform duration-500">
        <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm text-center border border-gray-100">
            <div class="text-5xl mb-4 animate-bounce">ğŸšœ</div>
            <h1 class="text-2xl font-bold text-gray-800 mb-2 font-serif">åä¸ªå‹¤å¤© Â· ä¸Šå¸‚ä¹‹è·¯</h1>
            <p class="text-sm text-gray-500 mb-8">AI é©±åŠ¨ Â· æ²‰æµ¸å¼æ‘æ°‘æ—¥è®°</p>
            
            <div class="space-y-3">
                <button onclick="App.showIntro()" class="w-full py-3.5 bg-emerald-500 text-white rounded-xl font-bold shadow-lg shadow-emerald-200 active:scale-95 transition-transform flex items-center justify-center gap-2">
                    <span>âœ¨</span> å¼€å§‹æ–°æ—…ç¨‹
                </button>
                <button onclick="App.loadGame(true)" class="w-full py-3 bg-white border-2 border-emerald-100 text-emerald-600 rounded-xl font-bold active:bg-emerald-50 transition-colors">
                    ğŸ“‚ ç»§ç»­æ—…ç¨‹ (è¯»æ¡£)
                </button>
                <button onclick="App.showSettings()" class="w-full py-3 text-gray-400 text-sm hover:text-gray-600">
                    âš™ï¸ API è®¾ç½®
                </button>
            </div>
            <div class="mt-6 text-[10px] text-gray-300">v7.0 Final Collection</div>
        </div>
    </div>

    <!-- èƒŒæ™¯ä»‹ç»å¼¹çª— (æ¶¦è‰²ç‰ˆ) -->
    <div id="intro-modal" class="fixed inset-0 z-[60] bg-black/60 flex items-center justify-center p-4 backdrop-blur-sm hidden opacity-0 transition-opacity duration-500">
        <div class="bg-[#fffdf5] w-full max-w-md rounded-xl shadow-2xl overflow-hidden paper-anim border border-stone-200 relative">
            <div class="absolute inset-0 opacity-10 pointer-events-none" style="background-image: radial-gradient(#a8a29e 1px, transparent 1px); background-size: 20px 20px;"></div>
            <div class="p-8 relative z-10">
                <div class="text-center mb-6">
                    <span class="text-2xl">âœ‰ï¸</span>
                    <h2 class="text-xl font-serif font-bold text-stone-800 mt-2">å†™ç»™åé™¡é—¨çš„ä¸€å°ä¿¡</h2>
                </div>
                <div class="prose prose-sm text-stone-600 leading-7 font-serif text-justify">
                    <p><strong>2023å¹´ï¼Œåˆå†¬ã€‚</strong></p>
                    <p>åé™¡é—¨çš„é£ï¼Œä¼¼ä¹æ¯”å¾€å¹´éƒ½è¦å†·å†½ä¸€äº›ã€‚</p>
                    <p>é‚£å¤©ï¼Œæ‘å£çš„ç¢çŸ³è·¯ä¸Šå¼€æ¥äº†ä¸€è¾†æ©™è‰²çš„å¤§å·´è½¦ï¼Œæ‰“ç ´äº†è¿™é‡Œçš„å®é™ã€‚è½¦é—¨æ‰“å¼€ï¼Œä¸‹æ¥äº†åä¸ªå¹´è½»çš„é¢å­”ã€‚ä»–ä»¬çœ‹ç€çœ¼å‰è¿™ç‰‡è’èŠœçš„ç›ç¢±åœ°å’Œå‡ é—´æ¼é£çš„å¹³æˆ¿ï¼Œçœ¼ç¥é‡Œé€ç€æ¸…æ¾ˆçš„è¿·èŒ«ã€‚</p>
                    <p>æ‘é‡Œäººéƒ½è¯´ï¼Œè¿™ç¾¤åŸé‡Œæ¥çš„å­©å­æ˜¯åœ¨ä½œç§€ï¼Œè‚¯å®šæ’‘ä¸è¿‡ä¸‰å¤©ã€‚</p>
                    <p>ä½†å½“ä½ çœ‹åˆ°ä»–ä»¬åœ¨å¯’é£ä¸­ç¬¨æ‹™åœ°æ¬è¿è¡Œæï¼Œçœ‹åˆ°ä»–ä»¬çœ¼é‡Œé‚£è‚¡å­è™½ç„¶å®³æ€•å´ä¸æœè¾“çš„åŠ²å¤´â€¦â€¦ä½œä¸ºçœ‹ç€è¿™ç‰‡åœŸåœ°é•¿å¤§çš„è€é‚»å±…ï¼Œä½ å†³å®šâ€”â€”</p>
                    <p><strong>å¸®å¸®ä»–ä»¬ã€‚</strong>ä¸ä»…æ˜¯ä¸ºäº†è¿™ç¾¤å­©å­ï¼Œä¹Ÿæ˜¯ä¸ºäº†è¿™ç‰‡æ²‰ç¡å·²ä¹…çš„åœŸåœ°ã€‚</p>
                </div>
                <div class="mt-8">
                    <button onclick="App.startGame()" class="w-full py-3 bg-stone-800 text-[#fffdf5] rounded-lg font-bold shadow-md hover:bg-stone-900 transition-colors flex items-center justify-center gap-2">
                        <span>ğŸ¤</span> æˆ‘å‡†å¤‡å¥½äº†ï¼Œè¿›æ‘ï¼
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»æ¸¸æˆç•Œé¢ -->
    <main id="main-scroll" class="flex-1 overflow-y-auto overflow-x-hidden bg-[#f3f4f6] relative w-full">
        
        <!-- å¼¹å¹•æ‚¬æµ®æ˜¾ç¤ºåŒºåŸŸ -->
        <div id="danmu-overlay" class="danmu-overlay"></div>

        <!-- å¸é¡¶çŠ¶æ€æ  -->
        <div class="sticky-stats py-2 px-3 md:hidden">
            <div class="flex items-center justify-between gap-3 overflow-x-auto hide-scrollbar">
                <div class="flex-shrink-0 flex flex-col items-center min-w-[70px]">
                    <span class="text-[10px] text-gray-400">èµ„é‡‘</span>
                    <span id="val-funds-m" class="font-bold text-sm text-red-500 font-mono">-35w</span>
                </div>
                <div class="h-6 w-[1px] bg-gray-200"></div>
                <div class="flex-1 flex gap-3 min-w-max">
                    <div class="w-16"><div class="flex justify-between text-[10px] text-gray-500"><span>åœŸåœ°</span><span id="txt-land-m">20</span></div><div class="h-1.5 bg-gray-100 rounded-full mt-0.5"><div id="bar-land-m" class="bg-emerald-500 h-1.5 rounded-full" style="width: 20%"></div></div></div>
                    <div class="w-16"><div class="flex justify-between text-[10px] text-gray-500"><span>å»ºè®¾</span><span id="txt-build-m">10</span></div><div class="h-1.5 bg-gray-100 rounded-full mt-0.5"><div id="bar-build-m" class="bg-blue-500 h-1.5 rounded-full" style="width: 10%"></div></div></div>
                    <div class="w-16"><div class="flex justify-between text-[10px] text-gray-500"><span>å“ç‰Œ</span><span id="txt-brand-m">0</span></div><div class="h-1.5 bg-gray-100 rounded-full mt-0.5"><div id="bar-brand-m" class="bg-purple-500 h-1.5 rounded-full" style="width: 0%"></div></div></div>
                </div>
            </div>
        </div>

        <div class="max-w-[1200px] mx-auto p-3 md:p-6 grid grid-cols-1 md:grid-cols-12 gap-4 md:gap-6 pb-24">
            
            <!-- å·¦ä¾§å†…å®¹åŒº -->
            <div class="md:col-span-8 flex flex-col gap-4">
                
                <!-- çŠ¶æ€é¢æ¿ (PC) -->
                <div class="dashboard-card p-5 hidden md:block">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-bold text-gray-700">å…¬å¸è¿è¥æ¦‚å†µ</h2>
                        <span id="season-badge" class="px-2 py-1 bg-gray-100 rounded text-xs text-gray-500">å¼€è’æœŸ</span>
                    </div>
                    <div class="grid grid-cols-4 gap-4 text-center divide-x divide-gray-100 mb-6">
                        <div><div class="text-xs text-gray-400 mb-1">åœŸåœ°å€¼</div><div id="val-land" class="text-xl font-bold text-emerald-600">20</div></div>
                        <div><div class="text-xs text-gray-400 mb-1">å»ºè®¾å€¼</div><div id="val-build" class="text-xl font-bold text-blue-600">10</div></div>
                        <div><div class="text-xs text-gray-400 mb-1">å“ç‰Œå€¼</div><div id="val-brand" class="text-xl font-bold text-purple-600">0</div></div>
                        <div><div class="text-xs text-gray-400 mb-1">å½“å‰èµ„é‡‘</div><div id="val-funds" class="text-xl font-bold text-red-500 font-mono">-35w</div></div>
                    </div>
                    <div class="grid grid-cols-2 gap-8">
                        <div>
                            <div class="flex justify-between text-xs text-gray-500 mb-1"><span>å­£èŠ‚è¿›åº¦</span><span id="val-season">0%</span></div>
                            <div class="w-full bg-gray-100 rounded-full h-2"><div id="bar-season" class="bg-emerald-400 h-2 rounded-full transition-all" style="width: 0%"></div></div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs text-gray-500 mb-1"><span>ä¸Šå¸‚è¿›åº¦ (IPO)</span><span id="val-ipo">0%</span></div>
                            <div class="w-full bg-gray-100 rounded-full h-2"><div id="bar-ipo" class="bg-yellow-400 h-2 rounded-full transition-all" style="width: 0%"></div></div>
                        </div>
                    </div>
                </div>

                <!-- å‰§æƒ…å¡ç‰‡ -->
                <div class="dashboard-card flex flex-col min-h-[50vh] md:min-h-[500px] transition-all relative">
                    <div class="p-4 border-b border-gray-100 bg-gray-50/50 flex justify-between items-center sticky top-0 md:static z-10 backdrop-blur-sm md:backdrop-blur-none">
                        <h2 id="story-title" class="font-bold text-gray-800 text-lg">å‡†å¤‡å°±ç»ª</h2>
                        <div id="loading-indicator" class="hidden flex space-x-1">
                            <div class="w-2 h-2 bg-emerald-400 rounded-full typing-dot"></div>
                            <div class="w-2 h-2 bg-emerald-400 rounded-full typing-dot"></div>
                            <div class="w-2 h-2 bg-emerald-400 rounded-full typing-dot"></div>
                        </div>
                    </div>
                    
                    <div class="p-5 md:p-8 flex-1 flex flex-col">
                        <!-- å‰§æƒ…æ­£æ–‡åŒº -->
                        <div id="story-content" class="prose prose-sm md:prose-base max-w-none text-gray-700 leading-8 flex-1 cursor-pointer" onclick="App.tryFastForward()" title="ç‚¹å‡»è·³è¿‡æ‰“å­—">
                            <p class="text-gray-400 italic text-center mt-10">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œå¼€å§‹ç¬¬ä¸€å¤©çš„æ•…äº‹ã€‚</p>
                        </div>
                        
                        <div id="error-box" class="hidden mt-6 p-4 bg-red-50 border border-red-100 rounded-xl text-sm text-red-600 flex items-start gap-2">
                            <span class="text-lg">âš ï¸</span>
                            <div>
                                <span id="error-msg" class="font-bold">å‘ç”Ÿé”™è¯¯</span>
                                <div class="mt-2">
                                    <button onclick="App.showSettings()" class="underline hover:text-red-800 mr-4">æ£€æŸ¥ API è®¾ç½®</button>
                                    <button onclick="App.useDemoMode()" class="underline hover:text-red-800">åˆ‡æ¢æ¼”ç¤ºæ¨¡å¼</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="start-btn-container" class="mt-10 mb-6 text-center">
                            <button onclick="App.startStreamGeneration()" class="px-8 py-3 bg-emerald-500 text-white rounded-full font-bold shadow-lg shadow-emerald-100 hover:bg-emerald-600 hover:scale-105 transition-all flex items-center gap-2 mx-auto animate-pulse">
                                <span>â–¶ï¸</span> <span id="start-btn-text">å¼€å¯ä»Šæ—¥å‰§æƒ…</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§å†…å®¹åŒº -->
            <div class="md:col-span-4 flex flex-col gap-4">
                <!-- æˆå‘˜å¥½æ„Ÿ -->
                <div class="dashboard-card p-4">
                    <h3 class="font-bold text-gray-700 mb-3 text-sm">æˆå‘˜å¥½æ„Ÿåº¦</h3>
                    <div id="members-list" class="flex md:flex-col gap-3 overflow-x-auto md:overflow-visible pb-2 md:pb-0 hide-scrollbar">
                        <!-- JSç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- åº•éƒ¨å›ºå®šæ“ä½œæ  -->
        <div id="choices-panel" class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-200 shadow-2xl p-4 transform translate-y-full transition-transform duration-300 z-50">
            <div class="max-w-[1200px] mx-auto">
                <div class="text-xs font-bold text-gray-400 uppercase tracking-wide mb-3 flex items-center gap-2">
                    <span>è¡ŒåŠ¨é€‰æ‹©</span>
                    <div class="h-px bg-gray-200 flex-1"></div>
                </div>
                <div id="choices-container" class="space-y-3">
                    <!-- æŒ‰é’®ç”± JS ç”Ÿæˆ -->
                </div>
            </div>
        </div>

    </main>

    <!-- è®¾ç½®å¼¹çª— -->
    <div id="settings-modal" class="fixed inset-0 bg-black/60 z-[70] flex items-center justify-center p-4 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden transform scale-95 transition-transform duration-300">
            <div class="p-5 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                <h3 class="font-bold text-gray-800">AI æ¥å£è®¾ç½®</h3>
                <button onclick="App.closeSettings()" class="text-gray-400 hover:text-gray-600">âœ•</button>
            </div>
            
            <div class="p-6 space-y-4">
                <div id="env-warning" class="hidden bg-amber-50 p-3 rounded-lg text-xs text-amber-700 leading-5 border border-amber-100 mb-2">
                    âš ï¸ æ£€æµ‹åˆ°æœ¬åœ°æ–‡ä»¶è¿è¡Œ (file://)ã€‚è‹¥è¿æ¥å¤±è´¥ï¼Œè¯·ä½¿ç”¨ VS Code Live Server è¿è¡Œã€‚
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">API åœ°å€ (Base URL)</label>
                    <input type="text" id="api-url-input" class="w-full border border-gray-300 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="https://api.deepseek.com">
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">API Key</label>
                    <input type="password" id="api-key-input" class="w-full border border-gray-300 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="sk-...">
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">æ¨¡å‹åç§° (Model)</label>
                    <input type="text" id="api-model-input" class="w-full border border-gray-300 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-emerald-500 outline-none" value="deepseek-chat">
                </div>

                <div id="test-result" class="text-xs text-center h-auto min-h-[1rem] whitespace-pre-wrap break-words"></div>
            </div>

            <div class="p-5 border-t border-gray-100 bg-gray-50 flex gap-3">
                <button onclick="App.testConnection()" class="px-4 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-lg text-sm font-bold flex-1 hover:bg-gray-50">æµ‹è¯•è¿æ¥</button>
                <button onclick="App.saveAndStart()" class="px-4 py-2.5 bg-emerald-600 text-white rounded-lg text-sm font-bold flex-1 hover:bg-emerald-700 shadow-md">ä¿å­˜è®¾ç½®</button>
            </div>
            <div class="px-5 pb-4 bg-gray-50 text-center">
                <button onclick="App.useDemoMode()" class="text-xs text-gray-400 underline hover:text-gray-600">æ— æ³•è¿æ¥ï¼Ÿåˆ‡æ¢è‡³æ¼”ç¤ºæ¨¡å¼</button>
            </div>
        </div>
    </div>

    <!-- Toast æç¤º -->
    <div id="toast" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/80 text-white px-6 py-3 rounded-xl shadow-lg text-sm z-[80] hidden opacity-0 transition-opacity flex items-center gap-2">
        <span id="toast-icon">âœ…</span> <span id="toast-msg">æç¤ºä¿¡æ¯</span>
    </div>

    <script>
        // === æ¸¸æˆæ•°æ® ===
        const MEMBERS = [
            { id: 'dunhao', name: 'è’‹æ•¦è±ª', color: 'bg-blue-500' }, { id: 'luzhuo', name: 'é¹­å“', color: 'bg-pink-500' },
            { id: 'gengyun', name: 'æè€•è€˜', color: 'bg-stone-600' }, { id: 'lihao', name: 'ææ˜Š', color: 'bg-yellow-500' },
            { id: 'yibo', name: 'èµµä¸€åš', color: 'bg-indigo-500' }, { id: 'zhuoyuan', name: 'å“æ²…', color: 'bg-emerald-500' },
            { id: 'xiaotong', name: 'èµµå°ç«¥', color: 'bg-orange-500' }, { id: 'haonan', name: 'ä½•æµ©æ¥ ', color: 'bg-cyan-500' },
            { id: 'shaoxi', name: 'é™ˆå°‘ç†™', color: 'bg-teal-500' }, { id: 'yiheng', name: 'ç‹ä¸€ç©', color: 'bg-rose-500' }
        ];

        const DEMO_SCENARIOS = [
            {
                title: "ğŸšœ 30å¨çš„æé™æŒ‘æˆ˜",
                story: "ä»Šå¤©æ˜¯æ¥åˆ°åé™¡é—¨çš„ç¬¬å…­å¤©ã€‚30å¨æœ‰æœºè‚¥è¿åˆ°äº†æ‘å£ï¼Œè·¯å¤ªçª„è½¦è¿›ä¸æ¥ã€‚\n\nâ€œè¿™æ€ä¹ˆæ¬å•Š...â€ é¹­å“çœ‹ç€å †ç§¯å¦‚å±±çš„è‚¥æ–™ï¼Œçœ‰å¤´ç´§é”ã€‚\n\nâ€œåˆ«åºŸè¯äº†ï¼Œå¹²å°±å®Œäº†ï¼â€æè€•è€˜äºŒè¯ä¸è¯´ï¼Œå’¬ç‰™æ‰›èµ·äº†ä¸€è¢‹ã€‚\n\nå¤©è‰²æ¸æš—ï¼Œå¯’é£åˆºéª¨ã€‚å¦‚æœä»Šæ™šæ¬ä¸å®Œï¼Œè¿™æ‰¹è‚¥æ–™å¯èƒ½ä¼šå—æ½®å¤±æ•ˆã€‚çœ‹ç€ä»–ä»¬æ»¡å¤´å¤§æ±—ã€æ­¥å±¥è¹’è·šçš„æ ·å­ï¼Œä½ å†³å®šåšç‚¹ä»€ä¹ˆã€‚",
                choices: [
                    { text: "ğŸ’ª ä¸»åŠ¨å¸®å¿™æ¬è¿", hint: "å¢åŠ å…¨å‘˜å¥½æ„Ÿ", impact: { land: 5, aff: { all: 2 } } },
                    { text: "ğŸ›º å€Ÿå‡ºè‡ªå®¶ä¸‰è½®è½¦", hint: "åŸºå»ºå€¼+5", impact: { build: 5, aff: { dunhao: 5 } } },
                    { text: "ğŸµ é€å»çƒ­æ°´å§œæ±¤", hint: "æ¢å¤ä½“åŠ›", impact: { aff: { xiaotong: 5, zhuoyuan: 5 } } }
                ],
                danmu: [{u:"æ‘æ°‘è€ç‹",c:"è¿™ç¾¤å¨ƒèƒ½è¡Œå—ï¼ŸğŸ¤”"}, {u:"çœŸçˆ±ç²‰",c:"å¿ƒç–¼è€•è€˜çš„è…°ï¼ğŸ˜­"}]
            }
        ];

        // === æ ¸å¿ƒé€»è¾‘ ===
        const App = {
            config: { apiUrl: 'https://api.deepseek.com', apiKey: '', model: 'deepseek-chat' },
            state: { 
                day: 1, season: "å¼€è’æœŸ", funds: -350000, land: 20, build: 10, brand: 0, seasonProgress: 0, ipoProgress: 0, 
                members: {}, lastStoryData: null 
            },
            isDemo: false,
            isTyping: false,
            typewriterTimer: null,
            currentFullHtml: '',
            onTypewriterComplete: null,

            init() {
                MEMBERS.forEach(m => this.state.members[m.id] = 20);
                if (window.location.protocol === 'file:') document.getElementById('env-warning').classList.remove('hidden');
                
                const savedConfig = localStorage.getItem('hdm_config_v2');
                if (savedConfig) {
                    this.config = JSON.parse(savedConfig);
                    document.getElementById('api-url-input').value = this.config.apiUrl;
                    document.getElementById('api-key-input').value = this.config.apiKey;
                    document.getElementById('api-model-input').value = this.config.model;
                }
            },

            showIntro() {
                document.getElementById('intro-modal').classList.remove('hidden');
                setTimeout(() => { document.getElementById('intro-modal').classList.remove('opacity-0'); }, 10);
            },

            startGame() {
                document.getElementById('intro-modal').classList.add('opacity-0');
                setTimeout(() => document.getElementById('intro-modal').classList.add('hidden'), 500);
                document.getElementById('screen-home').style.transform = 'translateY(-100%)';
                
                this.state = { 
                    day: 1, season: "å¼€è’æœŸ", funds: -350000, land: 20, build: 10, brand: 0, seasonProgress: 0, ipoProgress: 0, 
                    members: {}, lastStoryData: null 
                };
                MEMBERS.forEach(m => this.state.members[m.id] = 20);
                this.updateUI();
                
                document.getElementById('start-btn-container').classList.remove('hidden');
                document.getElementById('start-btn-text').innerText = "å¼€å¯ä»Šæ—¥å‰§æƒ…";
                document.getElementById('story-title').innerText = "æ–°çš„ç¯‡ç« ";
                document.getElementById('story-content').innerHTML = "<p class='text-gray-500 text-center mt-10'>ä¸€åˆ‡å‡†å¤‡å°±ç»ªã€‚<br>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œå¼€å§‹ç¬¬ä¸€å¤©çš„æ•…äº‹ã€‚</p>";
                document.getElementById('choices-container').innerHTML = '';
                this.toggleChoicesPanel(false);
            },

            // --- API & è®¾ç½® ---
            showSettings() { document.getElementById('settings-modal').classList.remove('hidden'); setTimeout(()=>document.getElementById('settings-modal').classList.remove('opacity-0'),10); },
            closeSettings() { document.getElementById('settings-modal').classList.add('opacity-0'); setTimeout(()=>document.getElementById('settings-modal').classList.add('hidden'),300); },
            
            async testConnection() {
                const resEl = document.getElementById('test-result');
                resEl.innerHTML = '<span class="text-gray-500">è¿æ¥ä¸­...</span>';
                let url = document.getElementById('api-url-input').value.trim().replace(/\/$/, '');
                if (!url.includes('/chat/completions')) { if (!url.endsWith('/v1')) url += '/v1'; url += '/chat/completions'; }
                const key = document.getElementById('api-key-input').value.trim();
                const model = document.getElementById('api-model-input').value.trim();
                if(!key) { resEl.innerHTML = '<span class="text-red-500">âŒ è¯·è¾“å…¥ API Key</span>'; return; }

                try {
                    const res = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                        body: JSON.stringify({ model, messages: [{ role: 'user', content: 'Hi' }], max_tokens: 5 })
                    });
                    if (res.ok) resEl.innerHTML = '<span class="text-green-600">âœ… è¿æ¥æˆåŠŸ</span>';
                    else resEl.innerHTML = `<span class="text-red-500">âŒ é”™è¯¯ ${res.status}</span>`;
                } catch (e) { resEl.innerHTML = '<span class="text-red-500">âŒ ç½‘ç»œé”™è¯¯</span>'; }
            },

            saveAndStart() {
                const url = document.getElementById('api-url-input').value.trim().replace(/\/$/, '');
                const key = document.getElementById('api-key-input').value.trim();
                const model = document.getElementById('api-model-input').value.trim();
                if (!key) { alert("è¯·è¾“å…¥ API Key"); return; }
                this.config = { apiUrl: url, apiKey: key, model };
                localStorage.setItem('hdm_config_v2', JSON.stringify(this.config));
                this.isDemo = false;
                this.closeSettings();
                this.showToast("è®¾ç½®å·²ä¿å­˜", "âœ…");
            },

            useDemoMode() { this.isDemo = true; this.closeSettings(); this.showToast("å·²åˆ‡æ¢è‡³æ¼”ç¤ºæ¨¡å¼", "ğŸ§ª"); },
            
            // --- å­˜æ¡£è¯»æ¡£ ---
            saveGame() { localStorage.setItem('hdm_save_data', JSON.stringify(this.state)); this.showToast("å­˜æ¡£æˆåŠŸ", "ğŸ’¾"); },
            loadGame(fromHome=false) {
                const d = localStorage.getItem('hdm_save_data');
                if(d) { 
                    this.state = JSON.parse(d); 
                    if(fromHome) document.getElementById('screen-home').style.transform='translateY(-100%)'; 
                    this.updateUI(); 
                    if(this.state.lastStoryData) { 
                        this.renderTurn(this.state.lastStoryData); 
                        document.getElementById('start-btn-container').classList.add('hidden'); 
                    } else {
                        document.getElementById('story-title').innerText = "è¯»å–æˆåŠŸ";
                        document.getElementById('story-content').innerHTML = "<p class='text-gray-500 text-center mt-10'>è¿›åº¦å·²æ¢å¤ã€‚<br>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç»§ç»­ã€‚</p>";
                        document.getElementById('start-btn-container').classList.remove('hidden');
                        document.getElementById('start-btn-text').innerText = "ç»§ç»­å‰§æƒ…";
                    }
                    this.showToast("è¯»æ¡£æˆåŠŸ", "ğŸ“‚"); 
                }
                else this.showToast("æš‚æ— å­˜æ¡£", "âš ï¸");
            },
            showToast(msg, icon) {
                const t = document.getElementById('toast');
                document.getElementById('toast-msg').innerText = msg; document.getElementById('toast-icon').innerText = icon;
                t.classList.remove('hidden','opacity-0'); setTimeout(()=>{ t.classList.add('opacity-0'); setTimeout(()=>t.classList.add('hidden'),300); }, 2000);
            },

            // --- æ ¸å¿ƒæµå¼ç”Ÿæˆ ---
            async startStreamGeneration(lastChoice = null) {
                document.getElementById('start-btn-container').classList.add('hidden');
                document.getElementById('error-box').classList.add('hidden');
                this.toggleChoicesPanel(false); 
                
                if(this.isDemo) {
                    await this.simulateStream(DEMO_SCENARIOS[0]);
                    return;
                }

                const prompt = this.buildPrompt(lastChoice);
                let url = this.config.apiUrl.replace(/\/$/, '');
                if (!url.includes('/chat/completions')) { if (!url.endsWith('/v1')) url += '/v1'; url += '/chat/completions'; }

                this.currentStreamText = "";
                this.tempJsonBuffer = "";
                this.isStreaming = true;
                let foundSeparator = false;
                
                const textBox = document.getElementById('story-content');
                const titleBox = document.getElementById('story-title');
                
                textBox.innerHTML = ''; 
                document.getElementById('choices-container').innerHTML = ''; // æ¸…ç©ºæ—§é€‰é¡¹
                document.getElementById('danmu-overlay').innerHTML = '';
                
                titleBox.innerText = `Day ${this.state.day} ç”Ÿæˆä¸­...`;
                textBox.classList.add('streaming-cursor');
                document.getElementById('loading-indicator').classList.remove('hidden');

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.config.apiKey}` },
                        body: JSON.stringify({
                            model: this.config.model,
                            messages: [{ role: 'user', content: prompt }],
                            temperature: 0.7,
                            stream: true
                        })
                    });

                    if (!response.ok) throw new Error(`API Error ${response.status}`);

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();

                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const dataStr = line.slice(6);
                                if (dataStr === '[DONE]') break;
                                try {
                                    const json = JSON.parse(dataStr);
                                    const content = json.choices[0].delta.content || "";
                                    
                                    if (!foundSeparator) {
                                        this.currentStreamText += content;
                                        if (this.currentStreamText.includes('[STORY_END]')) {
                                            const parts = this.currentStreamText.split('[STORY_END]');
                                            const storyPart = parts[0].replace('[STORY_START]', '');
                                            textBox.innerHTML = marked.parse(storyPart);
                                            this.tempJsonBuffer = parts[1] || "";
                                            foundSeparator = true;
                                        } else {
                                            let display = this.currentStreamText.replace('[STORY_START]', '');
                                            if (display.includes('[JSON_START]')) {
                                                display = display.split('[JSON_START]')[0];
                                                foundSeparator = true; 
                                            }
                                            textBox.innerHTML = marked.parse(display);
                                        }
                                    } else {
                                        this.tempJsonBuffer += content;
                                    }
                                } catch (e) {}
                            }
                        }
                    }
                    this.finalizeStream(foundSeparator);

                } catch (e) {
                    console.error(e);
                    // è‡ªåŠ¨åˆ‡æ¢åˆ°æ¼”ç¤ºæ¨¡å¼
                    this.showToast("è¿æ¥ä¸­æ–­ï¼Œå·²åˆ‡æ¢æ¼”ç¤ºæ¨¡å¼", "âš ï¸");
                    this.isDemo = true;
                    await this.simulateStream(DEMO_SCENARIOS[0]);
                } finally {
                    textBox.classList.remove('streaming-cursor');
                    document.getElementById('loading-indicator').classList.add('hidden');
                }
            },

            async simulateStream(data) {
                const textBox = document.getElementById('story-content');
                const titleBox = document.getElementById('story-title');
                textBox.innerHTML = '';
                titleBox.innerText = data.title;
                textBox.classList.add('streaming-cursor');
                
                const text = data.story;
                let i = 0;
                const timer = setInterval(() => {
                    textBox.innerHTML = marked.parse(text.substring(0, i));
                    i += 3; 
                    if (i > text.length) {
                        clearInterval(timer);
                        textBox.classList.remove('streaming-cursor');
                        this.renderChoices(data.choices);
                        this.renderDanmu(data.danmu);
                    }
                }, 10);
            },

            finalizeStream(foundSeparator) {
                let jsonStr = foundSeparator ? this.tempJsonBuffer : this.currentStreamText;
                let jsonData = null;
                
                // å¼ºåŒ–æå–
                jsonStr = jsonStr.replace('[JSON_START]', '').replace('[JSON_END]', '').trim();
                const match = jsonStr.match(/\{[\s\S]*\}/);
                if(match) {
                    try { jsonData = JSON.parse(match[0]); } catch(e){}
                }

                if (jsonData) {
                    if(jsonData.title) document.getElementById('story-title').innerText = jsonData.title;
                    this.renderChoices(jsonData.choices || []);
                    this.renderDanmu(jsonData.danmu || []);
                    localStorage.setItem('hdm_autosave', JSON.stringify(this.state)); 
                } else {
                    console.error("JSONè§£æå¤±è´¥", jsonStr);
                    // å®¹é”™ï¼šæ˜¾ç¤ºé‡è¯•
                    document.getElementById('choices-container').innerHTML = '<p class="text-red-500 text-xs p-2">æ•°æ®è§£æå¼‚å¸¸ï¼Œè¯·ç‚¹å‡»é‡è¯•ã€‚</p>';
                    this.toggleChoicesPanel(true);
                    document.getElementById('start-btn-container').classList.remove('hidden');
                }
            },

            buildPrompt(lastChoice) {
                return `
                ä½ æ˜¯ä¸€ä¸ªåŸºäºç»¼è‰ºã€Šç§åœ°å§ã€‹çš„æ¸¸æˆå‰§æƒ…ç”Ÿæˆå™¨ã€‚
                ã€å½“å‰çŠ¶æ€ã€‘Day ${this.state.day}, èµ„é‡‘${this.state.funds}, ä¸Šè½®é€‰æ‹©: ${lastChoice ? lastChoice.text : 'æ— '}ã€‚
                
                ã€é‡è¦ï¼šä¸¥æ ¼éµå®ˆè¾“å‡ºæ ¼å¼ã€‘
                è¯·æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼Œä¸è¦åŒ…å«å…¶ä»–å†…å®¹ï¼š

                [STORY_START]
                è¿™é‡Œå†™Markdownæ ¼å¼çš„å‰§æƒ…å†…å®¹...ï¼ˆ200å­—ä»¥ä¸Šï¼Œå¤šæ¢è¡Œï¼Œå¸¦Emojiï¼Œå¯¹è¯ç”¨åŒå¼•å·ï¼‰
                [STORY_END]

                [JSON_START]
                {
                    "title": "â›ˆï¸ æ ‡é¢˜",
                    "choices": [
                        { "text": "ğŸƒâ€â™‚ï¸ é€‰é¡¹æè¿°", "hint": "æç¤º", "impact": { "funds": -100, "land": 5 } }
                    ],
                    "danmu": [{ "u": "ç²‰ä¸", "c": "è¯„è®º" }]
                }
                [JSON_END]
                `;
            },

            toggleChoicesPanel(show) {
                const panel = document.getElementById('choices-panel');
                if(show) {
                    panel.classList.remove('translate-y-full');
                } else {
                    panel.classList.add('translate-y-full');
                }
            },

            renderChoices(choices) {
                const cBox = document.getElementById('choices-container');
                cBox.innerHTML = '';
                choices.forEach((c, idx) => {
                    const btn = document.createElement('button');
                    btn.className = "choice-btn w-full p-4 rounded-xl text-left bg-white shadow-sm flex justify-between items-center group mb-2";
                    btn.innerHTML = `
                        <span class="font-bold text-gray-700 text-sm group-hover:text-emerald-700">${c.text}</span>
                        <span class="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded group-hover:bg-emerald-100">${c.hint}</span>
                    `;
                    btn.onclick = () => this.handleChoice(c);
                    cBox.appendChild(btn);
                    
                    setTimeout(() => btn.classList.add('visible'), idx * 100);
                });
                
                this.toggleChoicesPanel(true); // æ˜¾ç¤ºé€‰é¡¹é¢æ¿
            },

            renderDanmu(danmus) {
                const dBox = document.getElementById('danmu-overlay'); 
                if(!dBox) return; 
                dBox.innerHTML = '';
                
                danmus.forEach((d, idx) => {
                    setTimeout(() => {
                        const row = document.createElement('div');
                        row.className = "danmu-item";
                        const color = ['text-blue-600','text-purple-600','text-pink-600'][Math.floor(Math.random()*3)];
                        row.innerHTML = `<span class="font-bold ${color}">${d.u}:</span> <span class="text-gray-600">${d.c}</span>`;
                        dBox.appendChild(row);
                        
                        setTimeout(() => row.remove(), 8000);
                    }, idx * 1500); 
                });
            },

            handleChoice(c) {
                if (c.impact) {
                    const i = c.impact;
                    if(i.funds) this.state.funds += i.funds;
                    if(i.land) this.state.land += i.land;
                    if(i.build) this.state.build += i.build;
                    if(i.brand) this.state.brand += i.brand;
                    if(i.aff && i.aff.all) MEMBERS.forEach(m => this.state.members[m.id] += i.aff.all);
                }
                this.state.day++;
                this.updateUI();
                
                this.toggleChoicesPanel(false); 
                document.getElementById('start-btn-container').classList.remove('hidden');
                document.getElementById('start-btn-text').innerText = "å¼€å¯ä¸‹ä¸€å¤©";
                document.getElementById('story-content').innerHTML += "<br><br><hr class='border-gray-200 my-4'><p class='text-center text-gray-300 text-xs'>æœ¬ç« ç»“æŸ</p>";
                document.getElementById('main-scroll').scrollTop = document.getElementById('main-scroll').scrollHeight;
            },

            updateUI() {
                const fundsText = (this.state.funds/10000).toFixed(1) + 'w';
                const fundsClass = `font-bold ${this.state.funds >= 0 ? 'text-red-500' : 'text-green-600'} text-lg font-mono`;

                const deskFunds = document.getElementById('val-funds');
                if (deskFunds) { deskFunds.innerText = fundsText; deskFunds.className = fundsClass; }

                const mobileFunds = document.getElementById('val-funds-m');
                if (mobileFunds) { mobileFunds.innerText = fundsText; mobileFunds.className = `font-bold text-sm font-mono ${this.state.funds >= 0 ? 'text-red-500' : 'text-green-600'}`; }

                const updateStat = (id, val, suffix) => {
                    const pct = Math.min(100, val);
                    const t = document.getElementById(`txt-${id}${suffix}`);
                    const b = document.getElementById(`bar-${id}${suffix}`);
                    const v = document.getElementById(`val-${id}${suffix}`);
                    if(t) t.innerText = val;
                    if(b) b.style.width = pct + '%';
                    if(v) v.innerText = val;
                };

                updateStat('land', this.state.land, '');
                updateStat('build', this.state.build, '');
                updateStat('brand', this.state.brand, '');
                updateStat('season', this.state.seasonProgress, '');
                updateStat('ipo', this.state.ipoProgress, '');

                updateStat('land', this.state.land, '-m');
                updateStat('build', this.state.build, '-m');
                updateStat('brand', this.state.brand, '-m');

                document.getElementById('game-date').innerText = `S1 Â· Day ${this.state.day}`;

                const list = document.getElementById('members-list');
                if (list) {
                    list.innerHTML = '';
                    MEMBERS.forEach(m => {
                        const v = this.state.members[m.id];
                        const div = document.createElement('div');
                        div.className = "flex-shrink-0 md:w-full flex md:flex-row flex-col items-center gap-2 p-2 bg-gray-50 rounded-lg md:justify-start min-w-[60px]";
                        div.innerHTML = `
                            <div class="w-8 h-8 rounded-full ${m.color} flex items-center justify-center text-white text-xs font-bold shadow-sm">${m.name[0]}</div>
                            <div class="flex-1 w-full md:w-auto text-center md:text-left">
                                <div class="text-xs font-bold text-gray-700 truncate">${m.name}</div>
                                <div class="w-full bg-gray-200 h-1 mt-1 rounded-full overflow-hidden"><div class="bg-pink-400 h-1" style="width:${v}%"></div></div>
                            </div>
                        `;
                        list.appendChild(div);
                    });
                }
            },

            // Demo Helper
            typewriter(html, element, onComplete) { /* Demo logic handled in simulateStream */ },
            tryFastForward() { /* Streaming logic handles real-time rendering */ }
        };

        window.onload = () => App.init();
    </script>
</body>
</html>
